window.RogueApp={};
RogueApp.initApp=function(d,N,i,p){function da(a){a=_.indexOf(p.TALENT_INDEX,a);return parseInt(i.activeTalents[a],10)}function y(a,b,c){c||(c="stats");for(var e in b[c])if(b[c].hasOwnProperty(e)){a[e]||(a[e]=0);a[e]+=b[c][e]}}function q(a,b){var c={};if(a.source&&a.dest){c[a.source.key]||(c[a.source.key]=0);c[a.source.key]+=a.qty;c[a.dest.key]||(c[a.dest.key]=0);c[a.dest.key]+=a.qty}else y(c,a,b);var e=0,f;for(f in c)if(c.hasOwnProperty(f))e+=c[f]*(i.weights[f]?i.weights[f]:0);return Math.round(e*
10)/10}function O(){for(var a={},b=0;b<s.length;b++){var c=i.gear[s[b]],e=t[c.item_id];if(e){y(a,e);var f=e.sockets&&e.sockets.length>0,g;for(g in e.sockets)if(e.sockets.hasOwnProperty(g)){var h=c["gem"+g],j;if(h&&h>0)(j=P[h])&&y(a,j);j[e.sockets[g]]||(f=false)}f&&y(a,e.socketbonus);c.reforge&&c.reforge&&y(a,c.reforge);if((c=c.enchant)&&c>0)(c=ea[c])&&y(a,c)}}z=a}function Q(a,b,c,e){z||O();c=e?0:(z[a]||0)-(c?c[a]||0:0);switch(a){case "expertise_rating":a=R[i.options.general.level].expertise_rating*
6.1-c;a=a<0?0:a;a=a>b?b:a;return i.weights.expertise_rating*a;case "hit_rating":e=R[i.options.general.level].hit_rating*(27-2*da("precision"));a=R[i.options.general.level].spell_hit*(17-2*da("precision"))-c;a=a<0?0:a;a=a>b?b:a;c=e-c;c=c<0?0:c;c=b-a>c?c:b-a;return i.weights.spell_hit*a+i.weights.hit_rating*c}return(i.weights[a]||0)*b}function S(a,b){return b.__aep-a.__aep}function T(a,b){for(var c=0;c<a.length;c++)if(a[c])a[c].__aep=q(a[c]);b||a.sort(S)}function fa(a,b){if(!a.sockets||a.sockets.length===
0)return b?{aep:0,gems:[]}:0;var c=0,e=q(a,"socketbonus"),f,g,h,j,l,k;if(b){l=[];k=[]}for(f=0;f<a.sockets.length;f++){h=a.sockets[f];for(g=0;g<n.length;g++){j=n[g];if(!(j.requires&&j.requires.profession&&!i.options.professions[j.requires.profession]))if(!(h=="Meta"&&j.slot!="Meta"))if(!(h!="Meta"&&j.slot=="Meta")){c+=q(j);if(b)l[l.length]=j.id;break}}}for(f=0;f<a.sockets.length;f++){h=a.sockets[f];for(g=0;g<n.length;g++){j=n[g];if(!(j.requires&&j.requires.profession&&!i.options.professions[j.requires.profession]))if(!(h==
"Meta"&&j.slot!="Meta"))if(!(h!="Meta"&&j.slot=="Meta"))if(j[h]){e+=q(j);if(b)k[k.length]=j.id;break}}}f=false;if(e>c){c=e;l=k;f=true}else{c=c;l=l}return b?{aep:c,takeBonus:f,gems:l}:c}function u(a){if(!a)return"";a=a.split(/[ _]/);for(var b,c,e=[],f=0;f<a.length;f++){b=a[f].substring(0,1).toUpperCase();c=a[f].substring(1).toLowerCase();e[f]=b+c}return e.join(" ")}function F(a){d("#log .inner").prepend("<div>"+a+"</div")}function U(a,b,c,e,f){a=va({name:a.name,quality:a.quality,message:b,submsg:c,
severity:e,messageClass:f});d("#console .inner").append(a)}function G(a){if(a.__statsToDesc)return a.__statsToDesc;var b=[],c;for(c in a.stats)if(a.stats.hasOwnProperty(c))b[b.length]="+"+a.stats[c]+" "+u(c);a.__statsToDesc=b.join("/");return a.__statsToDesc}function ga(){d(".flash").fadeOut("fast")}function H(a){var b=d(".flash");if(b.length===0){b=d("<div class='flash'></div>");b.hide().click(function(){B&&window.clearTimeout(B);ga()});d(document.body).append(b)}b.html(a);b.is(":visible")||d(".flash").fadeIn(1200);
B&&window.clearTimeout(B);B=window.setTimeout(ga,4E3)}function I(a,b,c){var e=d(a);_.each(c,function(f,g){var h=i.options[b];if(!h){i.options[b]={};h=i.options[b]}e.append(wa({key:g,label:f,checked:h[g]?"checked":"",namespace:b}))})}function ha(a){(a?a.find(".talent"):d("#talentframe .tree .talent")).each(function(){var b=d(this),c=d.data(this,"position"),e=d.data(c.tree,"info"),f=d.data(this,"icons");e.points<c.row*5?b.css({backgroundImage:f.grey}).removeClass("active"):b.css({backgroundImage:f.normal}).addClass("active")})}
function ia(){d("#talentframe .talent").each(function(){var a=d.data(this,"points");J(this,-a.cur,true)})}function K(a){ia();var b=0;d("#talentframe .talent").each(function(){J(this,parseInt(a[b],10),true);b++})}function ja(){return _.map(d("#talentframe .talent"),function(a){return d.data(a,"points").cur||0}).join("")}function J(a,b,c){var e=d.data(a,"points"),f=d.data(a,"position"),g=d.data(f.tree,"info"),h=false;if(c)h=true;else if(b==1&&e.cur<e.max&&ka<xa)h=true;else if(b==-1){for(c=7;c>f.row;c--){for(var j=
0,l=0;l<c;l++)j+=g.rowPoints[l];if(g.rowPoints[c]>0&&c*5>=j)return false}if(e.cur>0)h=true}if(h){e.cur+=b;g.points+=b;ka+=b;g.rowPoints[f.row]+=b}if(h){d.data(a,"spentButton").text(g.points);b=d.data(a,"pointsButton");b.get(0).className="points";if(e.cur==e.max)b.addClass("full");else e.cur>0&&b.addClass("partial");b.text(e.cur+"/"+e.max);ha(d(a).parent());i.activeTalents=ja()}return h}function V(a,b){var c=d(a).closest(".slot");d(".slots .slot").removeClass("active");c.addClass("active");var e=parseInt(c.attr("data-slot"),
10);d.data(document.body,"selecting-slot",e);d.data(document.body,"selecting-prop",b);return[c,e]}function W(){w.show();d(".popup #filter input").focus();var a=w.find(".active").get(0);if(a){a=a.offsetTop-w.height()/3;var b=a/1.3;if(b>500)b=500;w.animate({scrollTop:a},b,"swing")}}function la(a){a||(a=0);if(a===0)ma=C;var b=false;T(n);for(var c=0;c<s.length;c++){var e=i.gear[s[c]],f=t[e.item_id];if(f)for(var g=fa(f,true),h=0;h<g.gems.length;h++)if(e["gem"+h]!=g.gems[h]){e["gem"+h]=g.gems[h];F("Regemming "+
f.name+" socket "+(h+1)+" to "+P[g.gems[h]].name);b=true}}if(!b||a>=10){RogueApp.updateDisplayedGear();F("Finished automatic regemming: &Delta; "+Math.floor(C-ma)+" AEP")}else la(a+1)}function X(a){if(a.ilvl<200)return false;for(var b in a.stats)if(_.include(Y,b))return true;return false}function ya(a){var b=[],c;for(c in a)if(a.hasOwnProperty(c)&&_.include(Y,c))b[b.length]={key:c,name:u(c),value:a[c],use:Math.floor(a[c]*Z)};return b}function L(a,b){var c={},e,f,g,h,j,l=false,k;for(k in a)if(_.include(Y,
k)){l=true;for(var m=Math.floor(a[k]*Z),o=Q(k,-m),r=0;r<M.length;r++)if(!a[M[r].key]){var A=M[r].key,D=Q(A,m,b);c[k+"_to_"+A]=D+o;if(!f||Math.abs(D+o)>f)f=Math.abs(D+o);if(!e||D+o>e){e=D+o;g=k;h=A;j=m}}}if(l)return c=_.extend(c,{max:e,rmax:f,qty:j,source:{key:g,name:u(g)},dest:{key:h,name:u(h)}})}function na(a){a||(a=0);if(a===0)oa=C;for(var b=false,c=0;c<s.length;c++){var e=i.gear[s[c]],f=t[e.item_id];if(f)if(X(f)){var g=L(f.stats,e.reforge?e.reforge.stats:null);if(g&&(!e.reforge||e.reforge.from.stat!=
g.source.name||e.reforge.to.stat!=g.dest.name)){F("Reforging "+f.name+" to -"+g.qty+" "+g.source.name+"/+"+g.qty+" "+g.dest.name);b=true;e.reforge={stats:{}};e.reforge.stats[g.source.key]=-g.qty;e.reforge.stats[g.dest.key]=g.qty;e.reforge.from={stat:g.source.name,value:-g.qty};e.reforge.to={stat:g.dest.name,value:g.qty};O()}}}if(!b||a>=10){RogueApp.updateDisplayedGear();F("Finished automatic reforging: &Delta; "+Math.floor(C-oa)+" AEP")}else na(a+1)}function za(){var a=d.data(document.body,"selecting-slot"),
b=d.data(document.body,"reforge-amount"),c=d("#reforge input[name='oldstat']:checked").val(),e=d("#reforge input[name='newstat']:checked").val(),f=i.gear[a];f.reforge={};if(a!==undefined&&b!==undefined&&c!==undefined&&e!==undefined){f.reforge.stats={};f.reforge.stats[c]=-b;f.reforge.stats[e]=b;f.reforge.from={stat:u(c),value:-b};f.reforge.to={stat:u(e),value:b}}d("#reforge").fadeOut(150);RogueApp.updateDisplayedGear()}var R={80:{hit_rating:30.7548,spell_hit:26.24,expertise_rating:32.78998947}},pa=
{0:1,1:2,2:3,14:16,4:5,8:9,9:10,5:6,6:7,7:8,10:11,11:11,12:12,13:12,15:"mainhand",16:"offhand",17:"ranged"},M=[{key:"expertise_rating",val:"Expertise"},{key:"hit_rating",val:"Hit"},{key:"haste_rating",val:"Haste"},{key:"crit_rating",val:"Crit"},{key:"mastery_rating",val:"Mastery"}],Y=["crit_rating","hit_rating","haste_rating","expertise_rating","mastery_rating"],s=["0","1","2","14","4","8","9","5","6","7","10","11","12","13","15","16","17"],Z=0.4,xa=36;RogueApp.ServerData=p;RogueApp.Data=i;if(!i.options)i.options=
{};var z,t=p.ITEM_LOOKUP,$=p.WEIGHTS,qa=p.ITEMS,aa=p.SLOT_CHOICES,ba=p.TALENTS,Aa=p.TALENT_LOOKUP,P=p.GEMS,ea=p.ENCHANT_LOOKUP,ra=p.ENCHANT_SLOTS,n=p.GEM_LIST;if(!i.weights)i.weights=$;var sa=function(){return false};d.fn.disableTextSelection=function(){return d(this).each(function(){if(typeof this.onselectstart!="undefined")this.onselectstart=sa;else if(typeof this.style.MozUserSelect!="undefined")this.style.MozUserSelect="none";else{this.onmousedown=sa;this.style.cursor="default"}})};d.expr[":"].regex=
function(a,b,c){b=c[3].split(",");c=/^(data|css):/;c={method:b[0].match(c)?b[0].split(":")[0]:"attr",property:b.shift().replace(c,"")};return RegExp(b.join("").replace(/^\s+|\s+$/g,""),"ig").test(jQuery(a)[c.method](c.property))};RogueApp.setupLabel=function(){if(d(".label_check input").length){d(".label_check").each(function(){d(this).removeClass("c_on")});d(".label_check input:checked").each(function(){d(this).parent("label").addClass("c_on")})}if(d(".label_radio input").length){d(".label_radio").each(function(){d(this).removeClass("r_on")});
d(".label_radio input:checked").each(function(){d(this).parent("label").addClass("r_on")})}};d(".label_check, .label_radio").click(function(){RogueApp.setupLabel()});RogueApp.setupLabel();d("button, input:submit, .button").button();d("select").selectmenu({style:"dropdown"});d(document).mousemove(function(a){d.data(document,"mouse-x",a.pageX);d.data(document,"mouse-y",a.pageY)});var E=Handlebars.compile(d("#template-itemSlot").html()),Ba=Handlebars.compile(d("#template-stats").html()),Ca=Handlebars.compile(d("#template-reforge").html()),
wa=Handlebars.compile(d("#template-checkbox").html());$=Handlebars.compile(d("#template-tree").html());var Da=Handlebars.compile(d("#template-tooltip").html()),Ea=Handlebars.compile(d("#template-talent_set").html()),va=Handlebars.compile(d("#template-log").html()),Fa=d(".slots"),w=d(".alternatives"),x=d(".alternatives .body"),Ga=d.toJSON||Object.toJSON||window.JSON&&(JSON.encode||JSON.stringify),ka=0,C,B;window.flash=H;window.FLASH.length>0&&setTimeout(function(){H("<p>"+window.FLASH.join("</p><p>")+
"</p>")},1E3);d("form#new_item").bind("ajax:success",function(a,b){if(b.id&&b.name){if(!t[b.id]){t[b.id]=b;qa[qa.length]=b;if(b.equip_location)aa[b.equip_location][aa[b.equip_location].length]=b}H("Item added: "+b.name)}else H("Invalid item")});d(".floater h3").disableTextSelection();d("select#race").val(i.race).change(function(){i.race=d(this).val()});d(".popup").hide();d("#tabs").tabs();I("#professions","professions",{blacksmithing:"Blacksmithing",enchanting:"Enchanting",engineering:"Engineering",
inscription:"Inscription",jewelcrafting:"Jewelcrafting",leatherworking:"Leatherworking",tailoring:"Tailoring"});I("#buffs","playerBuffs",{bok:"Blessing of Kings",ap:"Battle Shout",haste:"Windfury"});I("#debuffs","targetDebuffs",{major_armor:"Major Armor",minor_armor:"Minor Armor",spell_hit:"Spell Hit"});I("#settings #rotation","rotation",{rvs_rupture_4:"Use Revealing Strike for 4CP Rupture?",rvs_rupture_5:"Use Revealing Strike for 5CP Rupture?",rvs_evis_4:"Use Revealing Strike for 4CP Eviscerate?",
rvs_evis_5:"Use Revealing Strike for 5CP Eviscerate?"});d(".optionCheck").change(function(){var a=d(this),b=a.attr("data-ns")||"root";i.options[b]||(i.options[b]={});i.options[b][a.attr("name")]=a.is(":checked");d.jStorage.set(N,i)});for(var v in i.weights)i.weights.hasOwnProperty(v)&&d("#weights .inner").append("<dt>"+u(v)+"</dt><dd><input type='text' id='weight-"+v+"' data-stat='"+v+"' value='"+i.weights[v]+"'/>");d("#weights .inner input").change(function(){var a=d.trim(d(this).attr("data-stat"));
i.weights[a]=parseFloat(d(this).val());RogueApp.updateDisplayedGear()});RogueApp.resetTalents=ia;RogueApp.setTalents=K;RogueApp.getTalents=ja;for(var ta in ba)if(ba.hasOwnProperty(ta)){v=ba[ta];d("#talentframe").append($({background:v.bgImage,talents:v.talent}))}d(".tree, .tree .talent, .tree .talent .points").disableTextSelection();d("#talentframe .talent").each(function(){var a=parseInt(this.className.match(/row-(\d)/)[1],10),b=parseInt(this.className.match(/col-(\d)/)[1],10),c=d(this),e=c.closest(".tree").get(0),
f=d("#talentframe .tree").index(e),g=Aa[f+":"+a+":"+b];d.data(this,"position",{tree:e,treeIndex:f,row:a,col:b});d.data(e,"info",{points:0,rowPoints:[0,0,0,0,0,0,0]});d.data(this,"talent",g);d.data(this,"points",{cur:0,max:g.maxRank});d.data(this,"pointsButton",d(this).find(".points"));d.data(this,"spentButton",d(this).closest(".tree").find(".spent"));d.data(this,"icons",{grey:c.css("backgroundImage"),normal:c.css("backgroundImage").replace(/\/grey\//,"/")})}).mousedown(function(a){if(d(this).hasClass("active")){switch(a.which){case 1:J(this,
1);break;case 3:J(this,-1)}d(this).trigger("mouseenter")}}).bind("contextmenu",function(){return false}).mouseenter(function(){var a=d.data(this,"points"),b=d.data(this,"talent"),c=b.rank.length?b.rank[a.cur-1]:b.rank,e=b.rank.length?b.rank[a.cur]:null,f=d(this).offset();a={title:b.name+" ("+a.cur+"/"+a.max+")",desc:c?c.description:null,nextdesc:e?"Next rank: "+e.description:null};b=f.left+130;f=f.top-20;c=d("#tooltip");if(!c||c.length===0){c=d("<div id='tooltip'></div>");d(document.body).append(c)}c.html(Da(a));
b=b||d.data(document,"mouse-x");f=f||d.data(document,"mouse-y");c.css({top:f,left:b}).show()}).mouseleave(function(){d("#tooltip").hide()});ha();for(var ca in i.talents)i.talents.hasOwnProperty(ca)&&d("#talentsets").append(Ea({talent_string:i.talents[ca],name:ca}));if(i.activeTalents)K(i.activeTalents);else for(var ua in i.talents)if(i.talents.hasOwnProperty(ua)){K(i.talents[ua]);break}d("#talentsets button.talent_set").live("click",function(){K(d(this).attr("data-talents"))});RogueApp.updateDisplayedGear=
function(){d.jStorage.set(N,i);d("#export").text("["+N+"]"+Ga(i));d("#console .inner").empty();O();var a=d("#stats .inner");a.empty();for(var b=[],c=_.keys(z).sort(),e=0,f=0;f<c.length;f++){var g=c[f],h=Q(g,z[g],null,true);e+=h;b[b.length]={name:u(g),val:z[g],aep:Math.floor(h)}}b[b.length]={name:"Total AEP",aep:Math.floor(e)};C=e;a.append(Ba({stats:b}));d(".slots").empty();var j;for(a=0;a<s.length;a++){b=s[a];c=i.gear[b];e=t[c.item_id];f=[];g=null;h=ea[c.enchant];var l;if(e){l=e;if(!l.sockets)l.sockets=
[];if(!l._sockets)l._sockets=l.sockets.slice(0);var k=i.options.professions.blacksmithing;if(l.equip_location==9||l.equip_location==10)if(k&&l.sockets[l.sockets.length-1]!="Prismatic")l.sockets[l.sockets.length]="Prismatic";else!k&&l.sockets[l.sockets.length-1]=="Prismatic"&&l.sockets[l.sockets.length].slice(0,l.sockets.length-2);l=ra[e.equip_location]!==undefined;k=e.sockets&&e.sockets.length>0;for(var m=0;m<e.sockets.length;m++){var o=P[c["gem"+f.length]];f[f.length]={socket:e.sockets[m],gem:o};
if(!o||!o[e.sockets[m]])k=false}if(k){g=[];for(var r in e.socketbonus)if(e.socketbonus.hasOwnProperty(r))g[g.length]={stat:r,amount:e.socketbonus[r]}}if(h&&!h.desc)h.desc=G(h);if(X(e))if(c.reforge){if((k=L(e.stats,c.reforge.stats))&&(c.reforge.from.stat!=k.source.name||c.reforge.to.stat!=k.dest.name)){m=Math.round(k[k.source.key+"_to_"+k.dest.key]*100)/100;if(!j||j<m){j=m;U(e,"is not using an optimal reforge","Using "+c.reforge.from.stat+" &Rightarrow; "+c.reforge.to.stat+", recommend "+k.source.name+
" &Rightarrow; "+k.dest.name+" (+"+m+")","warning","reforgeWarning")}}}else U(e,"needs to be reforged",void 0,"warning",void 0);!h&&l&&U(e,"needs to an enchantment",void 0,"warning",void 0)}Fa.append(E({item:e,aep:e?q(e):0,slot:b+"",gems:f,socketbonus:g,reforgable:e?X(e):false,reforge:c.reforge,sockets:e?e.sockets:null,enchantable:l,enchant:h}))}};RogueApp.updateDisplayedGear();d(".alternatives .slot").live("click",function(){var a=d.data(document.body,"selecting-slot"),b=d.data(document.body,"selecting-prop"),
c=d(this);if(b=="item_id"||b=="enchant"){c=parseInt(c.attr("id"),10);i.gear[a][b]=c>0?c:null;if(b=="item_id")i.gear[a].reforge=null}else if(b=="gem"){b=parseInt(c.attr("id"),10);c=d.data(document.body,"gem-slot");i.gear[a]["gem"+c]=b}RogueApp.updateDisplayedGear()});d(".slots .slot .name").live("click",function(){var a,b=V(this,"item_id"),c=b[1],e=+b[0].attr("id"),f=pa[c];w.animate({opacity:"hide"},"fast",function(){x.empty();var g=aa[f];T(n);for(a=0;a<g.length;a++){g[a].__gemRec=fa(g[a],true);g[a].__gemAEP=
Math.round(g[a].__gemRec.aep*10)/10;var h=L(g[a].stats);if(h){var j={};j[h.source.key]=-h.qty;j[h.dest.key]=h.qty;h=q({stats:j});g[a].__reforgeAep=h>0?h:0}else g[a].__reforgeAep=0;g[a].__aep=q(g[a])+g[a].__gemRec.aep+g[a].__reforgeAep}g.sort(S);h=g[0].__aep;for(a=0;a<g.length;a++){j=Math.round(g[a].__aep*10)/10;x.append(E({item:g[a],gear:{},gems:[],desc:q(g[a])+" base / "+g[a].__reforgeAep+" reforge / "+g[a].__gemAEP+" gem "+(g[a].__gemRec.takeBonus?"(Match gems)":""),search:g[a].name,percent:j/h*
100,aep:j}))}x.append(E({item:{name:"[No item]"},desc:"Clear this slot",percent:0,aep:0}));d(".alternatives .slot[id='"+e+"']").addClass("active");W()})});d(".slots .slot .enchant").live("click",function(){var a=V(this,"enchant")[1],b=pa[a];w.animate({opacity:"hide"},"fast",function(){x.empty();var c=ra[b];T(c);for(var e=i.gear[a].enchant,f=q(c[0]),g=0;g<c.length;g++){var h=c[g];if(h&&!h.desc)h.desc=G(h);var j=q(h);x.append(E({item:h,percent:j/f*100,aep:j,search:h.name+" "+h.desc,desc:h.desc}))}d(".alternatives .slot[id='"+
e+"']").addClass("active");W()})});var ma;RogueApp.optimizeGems=la;d(".slots .slot .gem").live("click",function(){var a=V(this,"gem"),b=a[0];a=a[1];var c=t[parseInt(b.attr("id"),10)],e=Math.floor((c.socketbonus?q(c,"socketbonus"):0)/c.sockets.length*10)/10,f=b.find(".gem").index(this);d.data(document.body,"gem-slot",f);var g=c.sockets[f],h=i.gear[a]["gem"+f];for(b=0;b<n.length;b++)n[b].__aep=q(n[b])+(n[b][c.sockets[f]]?e:0);n.sort(S);w.animate({opacity:"hide"},"fast",function(){x.empty();var j,l=
0,k,m,o={};for(j=0;j<n.length;j++){k=n[j];if(!(k.requires&&k.requires.profession&&!i.options.professions[k.requires.profession]))if(!(g=="Meta"&&k.slot!="Meta"))if(!(g!="Meta"&&k.slot=="Meta")){if(!m)m=k.__aep;if(o[k.name]){if(k.id==h)h=o[k.name]}else{l+=1;if(l>50)break;o[k.name]=k.id;var r=Math.round(k.__aep*10)/10,A=G(k);if(k[c.sockets[f]])A+=" (+"+Math.round(e*10)/10+" bonus)";x.append(E({item:k,aep:r,gear:{},search:k.name+" "+G(k)+" "+k.slot,percent:r/m*100,desc:A}))}}}d(".alternatives .slot[id='"+
h+"']").addClass("active");W()});return false});var oa;RogueApp.reforgeAll=na;d(".slots .slot .reforge").live("click",function(){d(".slot").removeClass("active");d(this).addClass("active");var a=d(this).closest(".slot"),b=parseInt(a.attr("data-slot"),10);d.data(document.body,"selecting-slot",b);a=parseInt(a.attr("id"),10);var c=t[a],e=i.gear[b].reforge?i.gear[b].reforge.stats:null;d.data(document.body,"reforge-amount",null);d("#reforge").animate({opacity:"hide"},"fast",function(){var f=L(c.stats,
e),g=ya(c.stats),h=_.select(M,function(j){return c.stats[j.key]===undefined});d.data(document.body,"reforge-recommendation",f);d.data(document.body,"reforge-item",c);d("#reforge").html(Ca({stats:g,newstats:h,recommended:f}));d("#reforge .pct").hide();d("#reforge .label_radio").click(RogueApp.setupLabel);d("#reforge input[type='button']").click(za);d("#reforge").animate({opacity:"show"},"fast")});return false});d(".oldstats input").live("change",function(){var a=d.data(document.body,"reforge-recommendation"),
b=d.data(document.body,"reforge-item"),c=d(this).val();d.data(document.body,"reforge-amount",Math.floor(b.stats[c]*Z));d("#reforge .pct").each(function(){var e=d(this),f=e.closest(".stat").attr("data-stat");f=a[c+"_to_"+f];var g=Math.abs(f)/a.rmax*50,h=e.find(".pct-inner");h.removeClass("reverse");e.find(".label").text(Math.floor(f*10)/10);f<0&&h.addClass("reverse");h.css({width:g+"%"});e.hide().fadeIn("normal")})});d(".slot a").live("click",function(){return false});d("body").click(function(){d(".popup").hide();
d(".slots .active").removeClass("active")}).keydown(function(a){a.keyCode==27&&d(".popup").hide()});d("#filter, #reforge").click(function(a){a.cancelBubble=true;a.stopPropagation()});d("input.search").keydown(function(a){var b=d(this),c=b.closest(".popup"),e;switch(a.keyCode){case 27:b.val("");b.blur();b.keyup();a.cancelBubble=true;a.stopPropagation();break;case 38:a=c.find(".slot:visible");for(b=0;b<a.length;b++)if(a[b].className.indexOf("active")!=-1){e=a[b-1]?d(a[b-1]):c.find(".slot:visible").last();
break}break;case 40:a=c.find(".slot:visible");for(b=0;b<a.length;b++)if(a.get(b).className.indexOf("active")!=-1){e=a[b+1]?d(a[b+1]):c.find(".slot:visible").first();break}break;case 13:c.find(".active").click();return}if(e){c.find(".slot").removeClass("active");e.addClass("active");a=e.get(0).offsetTop;b=c.height();if(a>c.scrollTop()+b-30)c.animate({scrollTop:e.get(0).offsetTop-b+e.height()+30},150);else a<c.scrollTop()&&c.animate({scrollTop:e.get(0).offsetTop-30},150)}}).keyup(function(){var a=d(this),
b=a.parents(".popup");a=d.trim(a.val().toLowerCase());b=b.find(".slot");a=b.filter(":regex(data-search, "+a+")");b=b.not(a);a.removeClass("hidden");b.addClass("hidden")})};
